Version 4
SHEET 1 11460 3748
WIRE 464 -256 -624 -256
WIRE 832 -256 464 -256
WIRE -1504 0 -1568 0
WIRE -1440 0 -1504 0
WIRE -1440 32 -1440 0
WIRE 3136 112 2864 112
WIRE 3760 112 3136 112
WIRE 3984 112 3856 112
WIRE 4080 112 3984 112
WIRE -1968 160 -2080 160
WIRE -1760 160 -1968 160
WIRE -1440 160 -1440 112
WIRE -1440 160 -1680 160
WIRE -2080 224 -2080 160
WIRE 4080 224 4080 112
WIRE -1856 240 -1888 240
WIRE -1824 240 -1856 240
WIRE -1888 272 -1888 240
WIRE 3136 272 3136 112
WIRE 3264 272 3136 272
WIRE 3504 272 3344 272
WIRE 3664 272 3504 272
WIRE 3808 272 3808 176
WIRE 3808 272 3664 272
WIRE -1968 288 -1968 160
WIRE -1920 288 -1968 288
WIRE -2208 304 -2256 304
WIRE -2176 304 -2208 304
WIRE -1440 304 -1440 160
WIRE -1440 304 -1856 304
WIRE -1920 320 -1968 320
WIRE -624 352 -624 -256
WIRE -544 352 -624 352
WIRE -416 352 -544 352
WIRE 752 352 544 352
WIRE 784 352 752 352
WIRE 832 352 784 352
WIRE -2256 368 -2256 304
WIRE 3504 368 3504 272
WIRE 4080 368 4080 304
WIRE -416 384 -416 352
WIRE 544 384 544 352
WIRE -272 400 -368 400
WIRE 496 400 416 400
WIRE 3664 432 3664 272
WIRE 3808 448 3808 272
WIRE -2256 480 -2256 448
WIRE -1968 480 -1968 320
WIRE -1968 480 -2256 480
WIRE -1696 480 -1968 480
WIRE -1440 480 -1440 304
WIRE -1440 480 -1616 480
WIRE -1312 480 -1440 480
WIRE -1152 480 -1200 480
WIRE -1072 480 -1152 480
WIRE 3504 480 3504 448
WIRE 3600 480 3504 480
WIRE -2256 512 -2256 480
WIRE 3504 544 3504 480
WIRE -416 592 -416 480
WIRE 48 592 -416 592
WIRE 544 592 544 480
WIRE 544 592 112 592
WIRE -624 608 -624 352
WIRE 752 608 752 352
WIRE -2256 624 -2256 592
WIRE -2080 624 -2080 288
WIRE -1888 624 -1888 336
WIRE 3504 656 3504 624
WIRE 3664 656 3664 528
WIRE 3808 656 3808 512
WIRE -416 672 -416 592
WIRE 544 672 544 592
WIRE 1872 672 1776 672
WIRE 2000 672 1872 672
WIRE 1008 688 912 688
WIRE 1136 688 1008 688
WIRE 1776 720 1776 672
WIRE 912 736 912 688
WIRE 3504 736 3504 704
WIRE -1440 752 -1440 480
WIRE -1072 752 -1072 480
WIRE -272 752 -272 400
WIRE -272 752 -368 752
WIRE -224 752 -272 752
WIRE 48 752 -224 752
WIRE 416 752 416 400
WIRE 416 752 112 752
WIRE 496 752 416 752
WIRE -416 768 -416 736
WIRE 416 800 416 752
WIRE 912 832 912 816
WIRE 1776 832 1776 800
WIRE 3664 832 3664 704
WIRE 1872 864 1776 864
WIRE 2000 864 1872 864
WIRE 3504 880 3504 816
WIRE 3600 880 3504 880
WIRE 992 912 912 912
WIRE 1072 912 992 912
WIRE 1776 912 1776 864
WIRE 3504 912 3504 880
WIRE -624 960 -624 688
WIRE -544 960 -624 960
WIRE -416 960 -416 768
WIRE -416 960 -544 960
WIRE 416 960 416 864
WIRE 416 960 -416 960
WIRE 544 960 544 768
WIRE 544 960 416 960
WIRE 752 960 752 672
WIRE 752 960 544 960
WIRE 912 960 912 912
WIRE 1776 1008 1776 992
WIRE 912 1056 912 1040
WIRE 3808 1056 3808 656
WIRE 4080 1088 4080 1024
WIRE 3216 1184 3136 1184
WIRE 3504 1184 3504 992
WIRE 3504 1184 3296 1184
WIRE 3664 1184 3664 928
WIRE 3664 1184 3504 1184
WIRE 3808 1184 3808 1120
WIRE 3808 1184 3664 1184
WIRE 3808 1232 3808 1184
WIRE 2976 1296 2864 1296
WIRE 3136 1296 3136 1184
WIRE 3136 1296 3056 1296
WIRE 3760 1296 3136 1296
WIRE 3968 1296 3856 1296
WIRE 4080 1296 4080 1168
WIRE 4080 1296 3968 1296
FLAG 4080 368 0
FLAG 4080 1024 0
FLAG -544 352 Vbat+
FLAG -1152 480 gate
FLAG -224 752 gate
FLAG -544 960 Vbat-
FLAG -1888 624 Vbat-
FLAG -2080 624 Vbat-
FLAG -2256 624 Vbat-
FLAG -1504 0 Vbat+
FLAG -1856 240 Vbat+
FLAG -2208 304 Vbat+
FLAG 912 832 0
FLAG 912 1056 0
FLAG 1008 688 output_power
FLAG 992 912 input_power
FLAG 1776 832 0
FLAG 1872 672 efficiency
FLAG 1776 1008 0
FLAG 1872 864 losses
FLAG 3984 112 vout+
FLAG 3968 1296 vout-
FLAG -1312 448 Vbat+
FLAG -1312 544 Vbat-
FLAG -1312 512 Vbat+
FLAG 2864 112 pos
FLAG 2864 1296 neg
FLAG 3808 656 0
FLAG 3664 656 0
FLAG 3504 656 0
FLAG 464 -256 pos
FLAG 784 352 neg
FLAG 3504 704 0
FLAG 3664 704 0
SYMBOL cap 112 576 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C6
SYMATTR Value {Cf}
SYMBOL cap 768 672 R180
WINDOW 0 24 56 Left 2
WINDOW 3 24 8 Left 2
SYMATTR InstName C7
SYMATTR Value {Cf}
SYMBOL cap 48 736 M90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C8
SYMATTR Value 10µ
SYMBOL diode 432 800 M0
SYMATTR InstName D8
SYMATTR Value 1N4148
SYMBOL voltage -624 592 M0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V5
SYMATTR Value 4.2
SYMBOL npn 3760 176 R270
SYMATTR InstName Q1
SYMATTR Value 2N3904
SYMBOL res 4064 208 R0
SYMATTR InstName R1
SYMATTR Value 100
SYMBOL res 3312 1168 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 1k
SYMBOL pnp 3760 1232 M90
SYMATTR InstName Q2
SYMATTR Value 2N3906
SYMBOL res 4096 1184 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R3
SYMATTR Value 100
SYMBOL cap 3792 1056 R0
SYMATTR InstName C3
SYMATTR Value 1µ
SYMBOL res 3360 256 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 1k
SYMBOL ZZZ\\Comparator\\LM339A_TI -1888 304 R0
SYMATTR InstName U1
SYMBOL res -2272 496 R0
SYMATTR InstName R5
SYMATTR Value 100k
SYMBOL res -2272 352 R0
SYMATTR InstName R6
SYMATTR Value 100k
SYMBOL res -1600 464 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 100k
SYMBOL res -1664 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R8
SYMATTR Value 150k
SYMBOL cap -2096 224 R0
SYMATTR InstName C1
SYMATTR Value 100p
SYMBOL res -1424 128 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R9
SYMATTR Value {Rgate}
SYMBOL bv 912 720 R0
SYMATTR InstName B1
SYMATTR Value V= if(time >  start_time, idt(V(pos, neg)*I(R10))/(time - start_time),0)
SYMBOL bv 912 944 R0
SYMATTR InstName B2
SYMATTR Value V=if(time > start_time, -idt(V(Vbat+, Vbat-)*I(V5)) / (time - start_time),0)
SYMBOL bv 1776 896 R0
SYMATTR InstName B3
SYMATTR Value V=  V(input_power) - V(output_power)
SYMBOL bv 1776 704 R0
SYMATTR InstName B4
SYMATTR Value V= min(max(V(output_power) / V(input_power),0), 1)
SYMBOL SN74LVC1G08 -1264 480 R0
SYMATTR InstName U7
SYMBOL res 3072 1280 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 1m
SYMBOL AO3401A 576 704 R0
SYMATTR InstName U5
SYMBOL AO3401A -448 448 R180
SYMATTR InstName U6
SYMBOL AO3400 576 416 M180
SYMATTR InstName M2
SYMBOL nmoss -368 672 M0
SYMATTR InstName U8
SYMATTR Value AO3400
SYMATTR SpiceModel AO3400
SYMBOL cap 3792 448 R0
SYMATTR InstName C4
SYMATTR Value 1µ
SYMBOL npn 3600 432 R0
SYMATTR InstName Q3
SYMATTR Value 2N3904
SYMBOL res 3520 464 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R12
SYMATTR Value 40k
SYMBOL res 3520 640 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R13
SYMATTR Value 10k
SYMBOL pnp 3600 928 M180
SYMATTR InstName Q4
SYMATTR Value 2N3906
SYMBOL res 3520 896 M0
SYMATTR InstName R11
SYMATTR Value 40k
SYMBOL res 3520 720 M0
SYMATTR InstName R14
SYMATTR Value 10k
TEXT -1000 880 Left 2 !.param fsw = 40k
TEXT -1000 912 Left 2 !.param d = 0.5
TEXT -1000 848 Left 2 !.param Cf = 10u
TEXT -1000 944 Left 2 !.tran 10m
TEXT -2272 40 Left 2 !;.step param Rgate list 50 100 200 400 600
TEXT 1144 712 Left 2 !.param start_time = 2m
TEXT -1264 64 Left 2 !.param Rgate = 1k
TEXT -32 416 Left 2 !.lib AO3400.mod
