Version 4
SHEET 1 11460 3748
WIRE 832 -256 -624 -256
WIRE 1104 -256 832 -256
WIRE 1280 -256 1104 -256
WIRE 1504 -256 1376 -256
WIRE 1600 -256 1504 -256
WIRE 1600 -144 1600 -256
WIRE 1104 -96 1104 -256
WIRE 1184 -96 1104 -96
WIRE 1328 -96 1328 -192
WIRE 1328 -96 1264 -96
WIRE 1328 -32 1328 -96
WIRE -1504 0 -1568 0
WIRE -1440 0 -1504 0
WIRE 1600 0 1600 -64
WIRE -1440 32 -1440 0
WIRE 1328 64 1328 32
WIRE 1328 112 1328 64
WIRE 1600 144 1600 80
WIRE -1968 160 -2080 160
WIRE -1760 160 -1968 160
WIRE -1440 160 -1440 112
WIRE -1440 160 -1680 160
WIRE -2080 224 -2080 160
WIRE -1856 240 -1888 240
WIRE -1824 240 -1856 240
WIRE 1184 240 1104 240
WIRE 1328 240 1328 176
WIRE 1328 240 1264 240
WIRE -1888 272 -1888 240
WIRE -1968 288 -1968 160
WIRE -1920 288 -1968 288
WIRE 1328 288 1328 240
WIRE -2208 304 -2256 304
WIRE -2176 304 -2208 304
WIRE -1440 304 -1440 160
WIRE -1440 304 -1856 304
WIRE -1920 320 -1968 320
WIRE -624 352 -624 -256
WIRE -544 352 -624 352
WIRE -416 352 -544 352
WIRE 752 352 544 352
WIRE 832 352 752 352
WIRE 944 352 832 352
WIRE 1104 352 1104 240
WIRE 1104 352 1024 352
WIRE 1280 352 1104 352
WIRE 1376 352 1360 352
WIRE 1488 352 1376 352
WIRE 1600 352 1600 224
WIRE 1600 352 1488 352
WIRE -2256 368 -2256 304
WIRE -416 384 -416 352
WIRE 544 384 544 352
WIRE -272 400 -368 400
WIRE 496 400 416 400
WIRE -2256 480 -2256 448
WIRE -1968 480 -1968 320
WIRE -1968 480 -2256 480
WIRE -1696 480 -1968 480
WIRE -1440 480 -1440 304
WIRE -1440 480 -1616 480
WIRE -1312 480 -1440 480
WIRE -1152 480 -1200 480
WIRE -1072 480 -1152 480
WIRE -2256 512 -2256 480
WIRE -416 592 -416 480
WIRE 48 592 -416 592
WIRE 544 592 544 480
WIRE 544 592 112 592
WIRE -624 608 -624 352
WIRE 752 608 752 352
WIRE -2256 624 -2256 592
WIRE -2080 624 -2080 288
WIRE -1888 624 -1888 336
WIRE -416 672 -416 592
WIRE 544 672 544 592
WIRE 1872 672 1776 672
WIRE 2000 672 1872 672
WIRE 1008 688 912 688
WIRE 1136 688 1008 688
WIRE 1776 720 1776 672
WIRE 912 736 912 688
WIRE -1440 752 -1440 480
WIRE -1072 752 -1072 480
WIRE -272 752 -272 400
WIRE -272 752 -368 752
WIRE -224 752 -272 752
WIRE 48 752 -224 752
WIRE 416 752 416 400
WIRE 416 752 112 752
WIRE 496 752 416 752
WIRE -416 768 -416 736
WIRE 416 800 416 752
WIRE 912 832 912 816
WIRE 1776 832 1776 800
WIRE 1872 864 1776 864
WIRE 2000 864 1872 864
WIRE 992 912 912 912
WIRE 1072 912 992 912
WIRE 1776 912 1776 864
WIRE -624 960 -624 688
WIRE -544 960 -624 960
WIRE -416 960 -416 768
WIRE -416 960 -544 960
WIRE 416 960 416 864
WIRE 416 960 -416 960
WIRE 544 960 544 768
WIRE 544 960 416 960
WIRE 752 960 752 672
WIRE 752 960 544 960
WIRE 912 960 912 912
WIRE 1776 1008 1776 992
WIRE 912 1056 912 1040
FLAG 1328 64 0
FLAG 1600 0 0
FLAG 1600 80 0
FLAG -544 352 Vbat+
FLAG -1152 480 gate
FLAG -224 752 gate
FLAG -544 960 Vbat-
FLAG -1888 624 Vbat-
FLAG -2080 624 Vbat-
FLAG -2256 624 Vbat-
FLAG -1504 0 Vbat+
FLAG -1856 240 Vbat+
FLAG -2208 304 Vbat+
FLAG 912 832 0
FLAG 912 1056 0
FLAG 1008 688 output_power
FLAG 992 912 input_power
FLAG 1776 832 0
FLAG 1872 672 efficiency
FLAG 1776 1008 0
FLAG 1872 864 losses
FLAG 1504 -256 vout+
FLAG 1488 352 vout-
FLAG -1312 448 Vbat+
FLAG -1312 544 Vbat-
FLAG -1312 512 Vbat+
FLAG 832 -256 pos
FLAG 832 352 neg
SYMBOL cap 112 576 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C6
SYMATTR Value {Cf}
SYMBOL cap 768 672 R180
WINDOW 0 24 56 Left 2
WINDOW 3 24 8 Left 2
SYMATTR InstName C7
SYMATTR Value {Cf}
SYMBOL cap 48 736 M90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C8
SYMATTR Value 10µ
SYMBOL diode 432 800 M0
SYMATTR InstName D8
SYMATTR Value 1N4148
SYMBOL voltage -624 592 M0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V5
SYMATTR Value 4.2
SYMBOL npn 1280 -192 R270
SYMATTR InstName Q1
SYMATTR Value 2N3904
SYMBOL res 1584 -160 R0
SYMATTR InstName R1
SYMATTR Value 100
SYMBOL res 1280 224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 1k
SYMBOL pnp 1280 288 M90
SYMATTR InstName Q2
SYMATTR Value 2N3906
SYMBOL res 1616 240 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R3
SYMATTR Value 100
SYMBOL cap 1312 -32 R0
SYMATTR InstName C2
SYMATTR Value 1µ
SYMBOL cap 1312 112 R0
SYMATTR InstName C3
SYMATTR Value 1µ
SYMBOL res 1280 -112 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 1k
SYMBOL ZZZ\\Comparator\\LM339A_TI -1888 304 R0
SYMATTR InstName U1
SYMBOL res -2272 496 R0
SYMATTR InstName R5
SYMATTR Value 100k
SYMBOL res -2272 352 R0
SYMATTR InstName R6
SYMATTR Value 100k
SYMBOL res -1600 464 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 100k
SYMBOL res -1664 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R8
SYMATTR Value 150k
SYMBOL cap -2096 224 R0
SYMATTR InstName C1
SYMATTR Value 100p
SYMBOL res -1424 128 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R9
SYMATTR Value {Rgate}
SYMBOL bv 912 720 R0
SYMATTR InstName B1
SYMATTR Value V= if(time >  start_time, idt(V(pos, neg)*I(R10))/(time - start_time),0)
SYMBOL bv 912 944 R0
SYMATTR InstName B2
SYMATTR Value V=if(time > start_time, -idt(V(Vbat+, Vbat-)*I(V5)) / (time - start_time),0)
SYMBOL bv 1776 896 R0
SYMATTR InstName B3
SYMATTR Value V=  V(input_power) - V(output_power)
SYMBOL bv 1776 704 R0
SYMATTR InstName B4
SYMATTR Value V= min(max(V(output_power) / V(input_power),0), 1)
SYMBOL SN74LVC1G08 -1264 480 R0
SYMATTR InstName U7
SYMBOL res 1040 336 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 1m
SYMBOL AO3401A 576 704 R0
SYMATTR InstName U5
SYMBOL AO3401A -448 448 R180
SYMATTR InstName U6
SYMBOL AO3400 576 416 M180
SYMATTR InstName M2
SYMBOL nmoss -368 672 M0
SYMATTR InstName U8
SYMATTR Value AO3400
SYMATTR SpiceModel AO3400
TEXT -1000 880 Left 2 !.param fsw = 40k
TEXT -1000 912 Left 2 !.param d = 0.5
TEXT -1000 848 Left 2 !.param Cf = 10u
TEXT -1000 944 Left 2 !.tran 10m
TEXT -2272 40 Left 2 !;.step param Rgate list 50 100 200 400 600
TEXT 1144 712 Left 2 !.param start_time = 2m
TEXT -1264 64 Left 2 !.param Rgate = 1k
TEXT -32 416 Left 2 !.lib AO3400.mod
